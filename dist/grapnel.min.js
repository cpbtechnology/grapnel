/****
 * Grapnel
 * https://github.com/bytecipher/grapnel
 *
 * @author Greg Sabia Tucker <greg@bytecipher.io>
 * @link http://bytecipher.io
 * @version 0.6.5
 *
 * Released under MIT License. See LICENSE.txt or http://opensource.org/licenses/MIT
*/

!function(a){function b(b){"use strict";return this.events={},this.state=null,this.options=b||{},this.options.env=this.options.env||(0===Object.keys(a).length&&process&&process.browser!==!0?"server":"client"),this.options.mode=this.options.mode||("server"!==this.options.env&&this.options.pushState&&a.history&&a.history.pushState?"pushState":"hashchange"),this.version="0.6.4",this}function c(a,b){this.stack=c.global.slice(0),this.router=a,this.runCallback=!0,this.callbackRan=!1,this.propagateEvent=!0,this.value=a.path();for(var d in b)this[d]=b[d];return this}function d(a){this.route=a,this.keys=[],this.regex=b.regexRoute(a,this.keys)}b.regexRoute=function(a,b,c,d){return a instanceof RegExp?a:(a instanceof Array&&(a="("+a.join("|")+")"),a=a.concat(d?"":"/?").replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(a,c,d,e,f,g){return b.push({name:e,optional:!!g}),c=c||"",""+(g?"":c)+"(?:"+(g?c:"")+(d||"")+(f||d&&"([^/.]+?)"||"([^/]+?)")+")"+(g||"")}).replace(/([\/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)"),new RegExp("^"+a+"$",c?"":"i"))},b._forEach=function(a,b){return"function"==typeof Array.prototype.forEach?Array.prototype.forEach.call(a,b):function(a,b){for(var c=0,d=this.length;d>c;++c)a.call(b,this[c],c,this)}.call(a,b)},b.prototype.get=b.prototype.add=function(a){var b=this,e=Array.prototype.slice.call(arguments,1,-1),f=Array.prototype.slice.call(arguments,-1)[0],g=new d(a),h=function(){var d=g.parse(b.path());if(d.match){var h={route:a,params:d.params,req:d,regex:d.match},i=new c(b,h).enqueue(e.concat(f));if(b.trigger("match",i,d),!i.runCallback)return b;if(i.previousState=b.state,b.state=i,i.parent()&&i.parent().propagateEvent===!1)return i.propagateEvent=!1,b;i.callback()}return b},i="pushState"!==b.options.mode&&"server"!==b.options.env?"hashchange":"navigate";return h().on(i,h)},b.prototype.trigger=function(a){var c=this,d=Array.prototype.slice.call(arguments,1);return this.events[a]&&b._forEach(this.events[a],function(a){a.apply(c,d)}),this},b.prototype.on=b.prototype.bind=function(a,c){var d=this,e=a.split(" ");return b._forEach(e,function(a){d.events[a]?d.events[a].push(c):d.events[a]=[c]}),this},b.prototype.once=function(a,b){var c=!1;return this.on(a,function(){return c?!1:(c=!0,b.apply(this,arguments),b=null,!0)})},b.prototype.context=function(a){var b=this,c=Array.prototype.slice.call(arguments,1);return function(){var d=arguments[0],e=arguments.length>2?Array.prototype.slice.call(arguments,1,-1):[],f=Array.prototype.slice.call(arguments,-1)[0],g="/"!==a.slice(-1)&&"/"!==d&&""!==d?a+"/":a,h="/"!==d.substr(0,1)?d:d.substr(1),i=g+h;return b.add.apply(b,[i].concat(c).concat(e).concat([f]))}},b.prototype.navigate=function(a,b){return this.path(a,b).trigger("navigate")},b.prototype.path=function(b,c,d){var e,f=this;return c&&"object"==typeof c||(c={}),d||(d=document.title+" "+b),"string"==typeof b?("pushState"===f.options.mode?(e=f.options.root?f.options.root+b:b,a.history.pushState(c,d,e)):a.location?a.location.hash=(f.options.hashBang?"!":"")+b:a._pathname=b||"",this):"undefined"==typeof b?("pushState"===f.options.mode?e=a.location.pathname.replace(f.options.root,"")+a.location.search:"pushState"!==f.options.mode&&a.location?(e=a.location.hash?a.location.hash.split(f.options.hashBang?"#!":"#")[1]:"",e+=a.location.search):e=a._pathname||"",e):b===!1?("pushState"===f.options.mode?a.history.pushState(c,d,f.options.root||"/"):a.location&&(a.location.hash=f.options.hashBang?"!":""),f):void 0},b.listen=function(){var a,c;return arguments[0]&&arguments[1]?(a=arguments[0],c=arguments[1]):c=arguments[0],function(){for(var a in c)this.add.call(this,a,c[a]);return this}.call(new b(a||{}))},c.global=[],c.prototype.preventDefault=function(){this.runCallback=!1},c.prototype.stopPropagation=function(){this.propagateEvent=!1},c.prototype.parent=function(){var a=!(!this.previousState||!this.previousState.value||this.previousState.value!=this.value);return a?this.previousState:!1},c.prototype.callback=function(){this.callbackRan=!0,this.timeStamp=Date.now(),this.next()},c.prototype.enqueue=function(a,b){for(var c=Array.isArray(a)?b<a.length?a.reverse():a:[a];c.length;)this.stack.splice(b||this.stack.length+1,0,c.shift());return this},c.prototype.next=function(){var a=this;return this.stack.shift().call(this.router,this.req,this,function(){a.next.call(a)})},d.prototype.parse=function(a){var c=/\?([\w-]+(=[\w-]*)?(&[\w-]+(=[\w-]*)?)*)?$/.exec(a);if(c){var d=a.substr(c.index+1);a=a.substr(0,c.index)}var e=a.match(this.regex),f=this,g={params:{},keys:this.keys,matches:(e||[]).slice(1),match:e,query:{}};if(b._forEach(g.matches,function(a,b){var c=f.keys[b]&&f.keys[b].name?f.keys[b].name:b;g.params[c]=a?decodeURIComponent(a):void 0}),d){var h=d.split("&");b._forEach(h,function(a){var b=a.split("=");g.query[b[0]]=b.length>1?b[1]:null})}return g},b.CallStack=c,b.Request=d,"function"!=typeof a.define||a.define.amd.grapnel?"object"==typeof module&&"object"==typeof module.exports?module.exports=exports=b:a.Grapnel=b:a.define(function(c,d,e){return a.define.amd.grapnel=!0,b})}.call({},"object"==typeof window?window:this);